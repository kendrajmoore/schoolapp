function __Iterator(v) {
    this.iterator = v.iterator();
}

__Iterator.prototype.hasNext = function() {
    var n = this.iterator.next();

    if (n.done)
        return false;

    this._next = n.value;
    return true;
};

__Iterator.prototype.next = function() {
    return this._next;
};

function __ArrayIterator(v) {
    this.array = v;
    this.index = 0;
}

__ArrayIterator.prototype.hasNext = function() {
    return this.index < this.array.length;
};

__ArrayIterator.prototype.next = function() {
    return this.array[this.index++];
};

function __ObjectIterator(v) {
    this.obj = v;
    this.keysIterator = new __ArrayIterator(Object.keys(v));
}

__ObjectIterator.prototype.hasNext = function() {
    return this.keysIterator.hasNext();
};

__ObjectIterator.prototype.next = function() {
    var k = this.keysIterator.next();
    return [k, this.obj[k]];
};

function __iterator(v) {
    if (typeof v.iterator === "function") {
        return new __Iterator(v);
    }

    if (typeof v === "string" || Object.prototype.toString.call(v) === "[object Array]") {
        return new __ArrayIterator(v);
    }

    return new __ObjectIterator(v);
}

function __IteratorValue(value, done) {
    this.done = done;
    this.value = value;
}

__IteratorValue.done = new __IteratorValue(void 0, true);

function __Generator(me, fn) {
    this.me = me;
    this.fn = fn;
    this.born = false;
    this.closed = false;
}

function __generatorYield(me, v, next) {
    me.fn = next;
    return new __IteratorValue(v, false);
}

function __generatorStop(me, v) {
    me.closed = true;
    return (v === void 0 ? __IteratorValue.done : new __IteratorValue(v, true));
}

__Generator.prototype = {
    iterator: function() {
        return this;
    },

    next: function() {
        return this.send();
    },

    send: function(v) {
        if (this.closed)
            throw new Error("generator is closed!");

        if (!this.born) {
            this.born = true;
            return this.fn.call(this.me, this);
        }

        if (!this.fn) {
            me.closed = true;
            return __IteratorValue.done;
        }

        return this.fn.call(this.me, null, v);
    },

    "throw": function(e) {
        if (this.closed)
            throw new Error("generator is closed!");

        if (!this.born) {
            throw e;
        }

        return this.fn.call(this.me, e);
    }
};

function __gen(me, fn) {
    return new __Generator(me, fn);
}

var should = require("should");
var Q = require("q");

describe('Generators', function() {
	//"use strict";

	it('can yield values', function() {
		function g() {
            return new __Generator(this, function(__generator) {
                return __generatorYield(__generator, 42);
            });
        }
		g().next().value.should.equal(42);
	})

	it('can accept values on yield', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                return __generatorYield(__generator, 42, function(e, __t6) {
                    (__t6).should.equal("hello");
                    return __generatorYield(__generator, "bye");
                });
            });
        }
        var i = g();
        i.next().value.should.equal(42);
        i.send("hello").value.should.equal("bye");
    })

	it('works with conditionals', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                if (true) {
                    return __generatorYield(__generator, 'Meee', function(e, __t10) {
                        return __t8_cc(__t10);
                    });
                } else {
                    return __t8_cc('You');
                }

                function __t8_cc(__t9_cv) {
                    var x = __t9_cv;
                    x.should.equal('Meee');
                    return __generatorYield(__generator, "bye");
                }

                return __t8_cc();
            });
        }
        var i = g();
        var v = i.next().value;
        v.should.equal('Meee');
        i.send(v).value.should.equal("bye");
    })

	it('doesn\'t evaluate false conditional', function() {
        var yielded = false;
        function g() {
            return new __Generator(this, function(__generator) {
                if (false) {
                    return __generatorYield(__generator, 'Meee', function(e, __t14) {
                        return __t12_cc(__t14);
                    });
                } else {
                    return __t12_cc('You');
                }

                function __t12_cc(__t13_cv) {
                    var x = __t13_cv;
                    x.should.equal('You');
                    yielded.should.equal(false);
                    return __generatorYield(__generator, "bye");
                }

                return __t12_cc();
            });
        }
        var i = g();
        var v = i.next().value;
        yielded = true;
    })


	it('works with logical expression', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                var __t16 = true;

                if (__t16) {
                    return __generatorYield(__generator, 'Meee', function(e, __t19) {
                        return __t17_cc(__t19);
                    });
                } else {
                    return __t17_cc(__t16);
                }

                function __t17_cc(__t18_cv) {
                    var x = __t18_cv;
                    x.should.equal('Meee');
                    return __generatorYield(__generator, "bye");
                }

                return __t17_cc();
            });
        }
        var i = g();
        var v = i.next().value;
        v.should.equal('Meee');
        i.send(v).value.should.equal("bye");
    })

	it('supports short circuit evaluation', function() {
        var yielded = false;
        function g() {
            return new __Generator(this, function(__generator) {
                var __t21 = 'You';

                if (!__t21) {
                    return __generatorYield(__generator, 'Meee', function(e, __t24) {
                        return __t22_cc(__t24);
                    });
                } else {
                    return __t22_cc(__t21);
                }

                function __t22_cc(__t23_cv) {
                    var x = __t23_cv;
                    x.should.equal('You');
                    yielded.should.equal(false);
                    return __generatorYield(__generator, "bye");
                }

                return __t22_cc();
            });
        }
        var i = g();
        var v = i.next().value;
        yielded = true;
        v.should.equal('bye');
    })



	it('works with if statement', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                var x;

                if (false) {
                    return __generatorYield(__generator, 'Not me', function(e, __t28) {
                        x = __t28;
                        return __t26_cc_if(null);
                    });
                } else {
                    return __t26_cc_if(null);
                }

                function __t26_cc_if(__t27_cv_if) {
                    if (true) {
                        return __generatorYield(__generator, 'Meee', function(e, __t31) {
                            x = __t31;
                            return __t29_cc_if(null);
                        });
                    } else {
                        x = 'You';
                        return __t29_cc_if(null);
                    }

                    function __t29_cc_if(__t30_cv_if) {
                        x.should.equal('Meee');
                        return __generatorYield(__generator, "bye");
                    }

                    return __t29_cc_if();
                }

                return __t26_cc_if();
            });
        }

        var i = g();
        var v = i.next().value;
        v.should.equal('Meee');
        i.send(v).value.should.equal("bye");
    })

	it('works with if statement condition', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                return __generatorYield(__generator, true, function(e, __t33) {
                    if (__t33) {
                        return __generatorYield(__generator, 'good', function(e, __t36) {
                            return __t34_cc_if(null);
                        });
                    } else {
                        return __generatorYield(__generator, 'bad', function(e, __t37) {
                            return __t34_cc_if(null);
                        });
                    }

                    function __t34_cc_if(__t35_cv_if) {
                        return __generatorStop(__generator);
                    }

                    return __t34_cc_if();
                });
            });
        }

        var i = g();
        var v = i.next().value;
        v.should.equal(true);
        i.send(v).value.should.equal("good");
    })

	it('works with nested if statement', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                var x;

                if (true) {
                    return __generatorYield(__generator, 'Meee', function(e, __t40) {
                        var y = __t40;

                        if (false) {
                            return __generatorYield(__generator, 'Arrgh', function(e, __t43) {
                                x = __t43;
                                return __t41_cc_if(null);
                            });
                        } else {
                            y.should.equal('Meee');

                            return __generatorYield(__generator, 'Me again', function(e, __t44) {
                                x = __t44;
                                return __t41_cc_if(null);
                            });
                        }

                        function __t41_cc_if(__t42_cv_if) {
                            y.should.equal('Meee');
                            return __t38_cc_if(null);
                        }

                        return __t41_cc_if();
                    });
                } else {
                    x = 'You';
                    return __t38_cc_if(null);
                }

                function __t38_cc_if(__t39_cv_if) {
                    x.should.equal('Me again');
                    return __generatorYield(__generator, "bye");
                }

                return __t38_cc_if();
            });
        }

        var i = g();
        var v = i.next().value;
        v.should.equal('Meee');
        v = i.send(v).value;
        v.should.equal("Me again");
        i.send(v).value.should.equal("bye");
    })


	it('works with while statement', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                var i = 0;
                return __t46_loop.call(this);

                function __t46_loop() {
                    if (i < 100000) {
                        if (i % 2 == 0) {
                            return __generatorYield(__generator, i, function(e, __t53) {
                                return __t51_cc_if(null);
                            });
                        } else {
                            return __t51_cc_if(null);
                        }

                        function __t51_cc_if(__t52_cv_if) {
                            i++;
                            return __t46_loop.call(this);
                            return __t49_cc_if(null);
                        }

                        return __t51_cc_if();
                    } else {
                        return __t49_cc_if(null);
                    }

                    function __t49_cc_if(__t50_cv_if) {
                        return __t47_cc_loop();
                    }

                    return __t49_cc_if();
                }

                function __t47_cc_loop(__t48_cv_loop) {
                    console.log('done');
                    return __generatorStop(__generator);
                }

                return __t47_cc_loop();
            });
        }

        var i = g();
        i.next().value.should.equal(0);
        i.next().value.should.equal(2);
        i.next().value.should.equal(4);
    })

	it('works with while statement condition', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                var i = 0;
                return __t54_loop.call(this);

                function __t54_loop() {
                    return __generatorYield(__generator, i++, function(e, __t57) {
                        if ((__t57) < 10) {
                            return __t54_loop.call(this);
                            return __t58_cc_if(null);
                        } else {
                            return __t58_cc_if(null);
                        }

                        function __t58_cc_if(__t59_cv_if) {
                            return __t55_cc_loop();
                        }

                        return __t58_cc_if();
                    });
                }

                function __t55_cc_loop(__t56_cv_loop) {
                    return __generatorYield(__generator, 'done');
                }

                return __t55_cc_loop();
            });
        }

        var i = g();
        i.next().value.should.equal(0);
        i.send(5).value.should.equal(1);
        i.next().value.should.equal('done');
    })

	it('works with nested while statement', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                var i = 0;
                return __t61_loop.call(this);

                function __t61_loop() {
                    if (i < 100000) {
                        var j = 1;
                        return __t66_loop.call(this);

                        function __t66_loop() {
                            if (j <= 2) {
                                return __generatorYield(__generator, i * j++, function(e, __t71) {
                                    return __t66_loop.call(this);
                                    return __t69_cc_if(null);
                                });
                            } else {
                                return __t69_cc_if(null);
                            }

                            function __t69_cc_if(__t70_cv_if) {
                                return __t67_cc_loop();
                            }

                            return __t69_cc_if();
                        }

                        function __t67_cc_loop(__t68_cv_loop) {
                            i++;
                            return __t61_loop.call(this);
                            return __t64_cc_if(null);
                        }

                        return __t67_cc_loop();
                    } else {
                        return __t64_cc_if(null);
                    }

                    function __t64_cc_if(__t65_cv_if) {
                        return __t62_cc_loop();
                    }

                    return __t64_cc_if();
                }

                function __t62_cc_loop(__t63_cv_loop) {
                    console.log('done');
                    return __generatorStop(__generator);
                }

                return __t62_cc_loop();
            });
        }

        var i = g();
        i.next().value.should.equal(0);
        i.next().value.should.equal(0);
        i.next().value.should.equal(1);
        i.next().value.should.equal(2);
        i.next().value.should.equal(2);
        i.next().value.should.equal(4);
    })


	// it('works with for-in statement', function (done) {
	// 	do {
	// 		var x = "";
			
	// 		for ( var i in {a:1, b:1} ) {
	// 			x += << async(i);
	// 		}

	// 		x.should.equal('ab');
	// 		done();
	// 	}
	// })


	it('works with for-of statement', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                var __t0 = __iterator(['a','b','c']);
                return __t72_loop.call(this);

                function __t72_loop() {
                    if (__t0.hasNext()) {
                        var x = __t0.next();

                        return __generatorYield(__generator, x, function(e, __t77) {
                            return __t72_loop.call(this);
                            return __t75_cc_if(null);
                        });
                    } else {
                        return __t75_cc_if(null);
                    }

                    function __t75_cc_if(__t76_cv_if) {
                        return __t73_cc_loop();
                    }

                    return __t75_cc_if();
                }

                function __t73_cc_loop(__t74_cv_loop) {
                    return __generatorStop(__generator);
                }

                return __t73_cc_loop();
            });
        }

        var i = g();
        i.next().value.should.equal('a');
        i.next().value.should.equal('b');
        i.next().value.should.equal('c');
    })
	
	it('works with nested for-of statement', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                var __t1 = __iterator(['a','b']);
                return __t78_loop.call(this);

                function __t78_loop() {
                    if (__t1.hasNext()) {
                        var x = __t1.next();
                        var __t2 = __iterator(['x','y']);
                        return __t83_loop.call(this);

                        function __t83_loop() {
                            if (__t2.hasNext()) {
                                var y = __t2.next();

                                return __generatorYield(__generator, x+y, function(e, __t88) {
                                    return __t83_loop.call(this);
                                    return __t86_cc_if(null);
                                });
                            } else {
                                return __t86_cc_if(null);
                            }

                            function __t86_cc_if(__t87_cv_if) {
                                return __t84_cc_loop();
                            }

                            return __t86_cc_if();
                        }

                        function __t84_cc_loop(__t85_cv_loop) {
                            return __t78_loop.call(this);
                            return __t81_cc_if(null);
                        }

                        return __t84_cc_loop();
                    } else {
                        return __t81_cc_if(null);
                    }

                    function __t81_cc_if(__t82_cv_if) {
                        return __t79_cc_loop();
                    }

                    return __t81_cc_if();
                }

                function __t79_cc_loop(__t80_cv_loop) {
                    return __generatorStop(__generator);
                }

                return __t79_cc_loop();
            });
        }

        var i = g();
        i.next().value.should.equal('ax');
        i.next().value.should.equal('ay');
        i.next().value.should.equal('bx');
        i.next().value.should.equal('by');
    })

	it('works with empty nested for-of statement', function() {
        function g() {
            return new __Generator(this, function(__generator) {
                var __t3 = __iterator([]);
                return __t89_loop.call(this);

                function __t89_loop() {
                    if (__t3.hasNext()) {
                        var x = __t3.next();
                        var __t4 = __iterator(['x','y']);
                        return __t94_loop.call(this);

                        function __t94_loop() {
                            if (__t4.hasNext()) {
                                var y = __t4.next();

                                return __generatorYield(__generator, x+y, function(e, __t99) {
                                    return __t94_loop.call(this);
                                    return __t97_cc_if(null);
                                });
                            } else {
                                return __t97_cc_if(null);
                            }

                            function __t97_cc_if(__t98_cv_if) {
                                return __t95_cc_loop();
                            }

                            return __t97_cc_if();
                        }

                        function __t95_cc_loop(__t96_cv_loop) {
                            return __t89_loop.call(this);
                            return __t92_cc_if(null);
                        }

                        return __t95_cc_loop();
                    } else {
                        return __t92_cc_if(null);
                    }

                    function __t92_cc_if(__t93_cv_if) {
                        return __t90_cc_loop();
                    }

                    return __t92_cc_if();
                }

                function __t90_cc_loop(__t91_cv_loop) {
                    return __generatorStop(__generator);
                }

                return __t90_cc_loop();
            });
        }

        var i = g();
        i.next().done.should.exist;
    })
});